<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating...</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #0a1628;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563EB;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            color: #f87171;
            margin-top: 10px;
            max-width: 400px;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="spinner" id="spinner"></div>
    <p id="status">Completing authentication...</p>
    <p id="error" class="error" style="display:none;"></p>

    <script>
        // ── Config ──────────────────────────────────────────────────────────
        const API_BASE = 'https://sia3136-codeshield-backend.hf.space';
        const APP_URL = window.location.origin; // Vercel frontend root

        // ── Main ────────────────────────────────────────────────────────────
        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');

            if (error) {
                showError(params.get('error_description') || error);
                return;
            }
            if (!code) {
                showError('Authorization code missing.');
                return;
            }

            // Detect provider from state param (google_ prefix) or URL content
            const isGoogle = (state && state.startsWith('google'))
                || window.location.search.includes('scope=email')
                || window.location.search.includes('scope=profile');
            const provider = isGoogle ? 'google' : 'github';

            console.log(`[OAuth] Detected Provider: ${provider}`);
            console.log(`[OAuth] Query Params: code=${code ? 'present' : 'missing'}, state=${state || 'none'}`);
            setStatus(`Exchanging ${provider} authorization...`);

            try {
                // ─── Exchange code with backend ─────────────────────────────
                const callbackUrl = `${API_BASE}/auth/${provider}/callback`;
                console.log(`[OAuth] Fetching: ${callbackUrl}`);

                const res = await fetch(callbackUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, state })
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    const msg = errData.detail || `Server returned ${res.status}`;
                    console.error(`[OAuth] Backend error:`, errData);
                    throw new Error(msg);
                }

                const data = await res.json();
                const token = data.access_token;

                if (!token) {
                    console.error('[OAuth] No token in response:', data);
                    throw new Error('Response missing access_token');
                }

                // ─── Save token to localStorage ─────────────────────────────
                localStorage.setItem('auth_token', token);
                console.log('[OAuth] Token saved to localStorage successfully');

                // ─── Also try to notify the opener (popup flow) ─────────────
                notifyOpener({ type: 'oauth_complete', provider, token });

                // ─── Close popup or redirect to app ─────────────────────────
                setStatus('Authentication successful! Redirecting...');

                // Extra check: verify token was actually written
                if (localStorage.getItem('auth_token') !== token) {
                    console.warn('[OAuth] LocalStorage write check failed!');
                }

                // If we're in a popup, try to close; parent will detect the token
                if (window.opener && !window.opener.closed) {
                    console.log('[OAuth] Closing popup...');
                    setTimeout(() => window.close(), 1000);
                } else {
                    console.log('[OAuth] Redirecting full page...');
                    setTimeout(() => { window.location.href = APP_URL; }, 800);
                }

            } catch (err) {
                console.error('[OAuth] Exchange failed:', err);
                showError(`${provider.toUpperCase()} Auth Error: ${err.message}`);
                // If it fails, we don't close the window so the user can see the error
            }
        }

        // ── Helpers ─────────────────────────────────────────────────────────
        function notifyOpener(payload) {
            // Best-effort: tell the opener the token is ready
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage(payload, APP_URL);
                }
            } catch (_) { }
            try {
                const bc = new BroadcastChannel('codeshield_oauth');
                bc.postMessage(payload);
                bc.close();
            } catch (_) { }
        }

        function setStatus(msg) {
            document.getElementById('status').innerText = msg;
        }

        function showError(msg) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status').innerText = 'Authentication failed';
            const el = document.getElementById('error');
            el.innerText = msg;
            el.style.display = 'block';
        }

        handleCallback();
    </script>
</body>

</html>